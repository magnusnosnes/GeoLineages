---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%", warning=FALSE, message=F
)
```


## Using LineageHomology for a given phylogeny and with tips observed in geographical locations.

#### Table of contents 
* [Estimating local transmission linages for phylogeographic data with two categories.](#estimating-local-transmission-linages-for-phylogeographic-data-with-two-categories)
* [Simulate tip data with two locations](#simulate-phylogeographic-data-with-two-locations--norway-and-rest-of-the-world--row-)
* [Plotting transmission lineages](#plot-lineage-densities-over-time)
    - [Color the lineages after location](#we-can-color-the-groups-by-the-state-they-are-in--and-restrict-the-plotted-groups-to-sizes-larger-than-1-4--and-10)
* [Plot cumulative lineage size over time.](#plot-cumulative-lineage-size-over-time)
    - [Again we can add color to the groups by specifying it.](#again-we-can-add-color-to-the-groups-by-specifying-it)




```{r,fig.width=10,fig.height=7}
#Load needed packages
library(LineageHomology)
library(ggplot2)
library(scales)
library(lubridate)

#Loading other packages for simulating data. 
library(ape)
library(phytools)
library(phangorn)
library(BactDating)

```

##### Simulate tip data with two different state.
For the purpose of this example we let the geographical states represent Norway and the rest of the World (RoW). The package was originally developed for data such as this.

```{r,fig.width=10,fig.height=15}
set.seed(400)
tree_test = simdatedtree(nsam=300, dateroot=2000) #300 taxa and date of the root at year 2000-
tree_test = ladderize(tree_test) #Reorder the tree to make it look nice
Q=matrix(c(0.5,0.5,0.5,0.5), nrow=2,ncol=2, byrow=F) #Set up a transition matrix for trait simulation
colnames(Q)=c("Norway","RoW") #From state 1 to state 2. 
rownames(Q)=c("Norway","RoW") #From state 1 to state 2. 

trait = phytools::sim.Mk(tree=tree_test,Q=Q,nsim=1) #Simulate the traits on the phylogeny

#Reconstruct ancestral states using ace. 
fit1 = ace(x=trait, phy= tree_test, type="discrete", mod="ARD") #Estimate the ancestral history

plot.phylo(tree_test,lwd=2,label.offset = 0.15, mar=c(0.2,0.2,0.2,0.2),cex=0.3) #Ploy phylogeny

axisPhylo(root.time=2000, backward=F) #Add time axis

nodelabels(pie=fit1$lik.anc,cex=0.2,piecol=c("Red","Blue"))
tips = to.matrix(trait,seq=c("Norway", "RoW"))
tiplabels(pie=tips, cex=0.2,piecol=c("Red","Blue"))

```
 
The nodes on the phylogeny are piecharts that represents the probability of either geographical state, where red represents Norway and blue represents RoW. LineageHomology uses the probabilities to count connected groups of taxa, where all the nodes on the paths between them have a probability that > 50% for the same geographical state. It also returns the number of singletons, dates and has a number of different plotting methods to display the results. 

 
```{r,fig.width=10,fig.height=15}
Result = LineageHomology(tree_test, ace_nodes=fit1$lik.anc,
                        ace_tips = to.matrix(trait, seq=c("Norway", "RoW")), start_time=2000)

```

LineageHomology outputs a list of lists. 

* Import_LocalTrans
contains an estimate of the number of taxa that are have changed state wrt. the state of the closest common ancestral node shared with any other taxa. 
* Lineage_sizes contains the number of taxa that belong to the mapped state. This means that for the entire group, all the interal nodes will be mapped to the same state with 50% or higher probability. 
*Taxa names contains sub lists for each lineage, in the same order as the other lists. 
   + Each sub list contains the taxa names of all the taxa in the group. 
* MRCA's contains the time of the most recent common ancestor of the groups. 
* Lineage_state contains the state the groups are mapped to, the states are treated as numbers in the anlyses, so the relative ordering has to be looked up.


```{r,fig.width=10,fig.height=7}
names(Result)
Result$Import_LocalTrans
Result$lineage_state
Result$Lineage_sizes
head(Result$Taxa_names)
Result$`MRCA's`
Result$lineage_state


```

#Make a treemap plot to get a quick overview of the lineages.

```{r,fig.width=10,fig.height=7}
LineageHomology::treemap_lineagehomology(Result)
```



##### Plot lineage densities over time 

```{r,fig.width=10,fig.height=7}
#Set up matrix with taxa info
name_date = data.frame(name = names(trait), dates= BactDating::leafDates(tree_test))
Result_lineage_info = LineageHomology::lineage_info(Result,name_date)
LineageHomology::ridgeplot_lineagedensities(Result_lineage_info=Result_lineage_info,groups_larger_than = 1,datelims=c("2000-01-01","2025-01-01","3 year"),color_by_state = F)
```

##### We can color the groups by the state they are in, and restrict the plotted groups to sizes larger than 1,4, and 10

```{r,fig.width=10,fig.height=7}

LineageHomology::ridgeplot_lineagedensities(Result_lineage_info=Result_lineage_info,groups_larger_than = 1,datelims=c("2000-01-01","2025-01-01","3 year"),color_by_state = T)

LineageHomology::ridgeplot_lineagedensities(Result_lineage_info=Result_lineage_info,groups_larger_than = 4,datelims=c("2000-01-01","2025-01-01","3 year"),color_by_state = T)

LineageHomology::ridgeplot_lineagedensities(Result_lineage_info=Result_lineage_info,groups_larger_than = 10,datelims=c("2000-01-01","2025-01-01","3 year"),color_by_state = T)


```
 
##### Plot cumulative lineage size over time. 

```{r,fig.width=10,fig.height=7}

LineageHomology::lineage_growth_cumulative(Result_lineage_info = Result_lineage_info, datelims=c("2000-01-01","2025-01-01","3 year"))

```
 
##### Again we can add color to the groups by specifying it.

```{r,fig.width=10,fig.height=7}
LineageHomology::lineage_growth_cumulative(Result_lineage_info = Result_lineage_info, datelims=c("2000-01-01","2025-01-01","3 year"),color_by_state = T)

```

